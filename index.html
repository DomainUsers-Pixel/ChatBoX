<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChatBox â€” Enhanced (Single File)</title>
<style>
  :root{
    --bg:#071826; --card:#0b1520; --accent:#7c3aed; --accent2:#06b6d4; --muted:#94a3b8;
    --glass: rgba(255,255,255,0.03); --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;color:#e6eef8;background:linear-gradient(180deg,#071023 0%, #071a2d 100%);}
  .app{max-width:1200px;margin:20px auto;height:86vh;border-radius:14px;display:grid;grid-template-columns:280px 1fr 320px;gap:16px;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 30px rgba(2,6,23,0.7);}
  /* SIDEBAR */
  .sidebar{background:var(--card);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700}
  .brand h1{font-size:16px;margin:0}
  .search{padding:8px;border-radius:10px;background:var(--glass);display:flex;gap:8px;align-items:center}
  .search input{flex:1;background:transparent;border:0;outline:none;color:var(--muted)}
  .list{overflow:auto;padding-right:6px;max-height:54vh}
  .room-item{display:flex;align-items:flex-start;gap:10px;padding:10px;border-radius:10px;cursor:pointer;transition:transform .12s, background .12s}
  .room-item:hover{transform:translateY(-3px);background:rgba(255,255,255,0.02)}
  .room-item .avatar{width:44px;height:44px;border-radius:8px;background:#0e2030;display:flex;align-items:center;justify-content:center;font-weight:700}
  .room-meta{flex:1}
  .small{font-size:13px;color:var(--muted)}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px}
  /* CHAT */
  .chat{background:var(--card);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;overflow:hidden}
  .chat-head{display:flex;align-items:center;justify-content:space-between;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
  .msg{max-width:72%;padding:10px;border-radius:10px;line-height:1.3;word-wrap:break-word;box-shadow:0 6px 14px rgba(2,6,23,0.5)}
  .msg.me{align-self:flex-end;background:linear-gradient(180deg,#3b82f6,#60a5fa);color:#021124;border-bottom-right-radius:4px}
  .msg.others{align-self:flex-start;background:rgba(255,255,255,0.03)}
  .msg .from{font-size:12px;color:var(--muted);margin-bottom:6px}
  .msg .time{font-size:11px;color:var(--muted);margin-top:8px;text-align:right}
  .composer{display:flex;gap:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.02)}
  .composer textarea{flex:1;padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.02);color:inherit;resize:none;height:58px}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:0;padding:10px 14px;border-radius:10px;color:white;cursor:pointer}
  /* RIGHT PANEL */
  .right{background:var(--card);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:12px;overflow:auto}
  .profile{display:flex;gap:12px;align-items:center}
  .profile .avatar{width:56px;height:56px;border-radius:12px;background:#092036;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px}
  .muted{color:var(--muted);font-size:14px}
  .overlay{position:fixed;inset:0;background:linear-gradient(0deg,rgba(2,6,23,0.65),rgba(2,6,23,0.65));display:flex;align-items:center;justify-content:center;z-index:200}
  .panel{width:460px;background:linear-gradient(180deg,#06111b,#071826);padding:18px;border-radius:12px;box-shadow:0 15px 40px rgba(2,6,23,0.7)}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .field input, .field textarea, .field select{padding:10px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit;outline:none}
  .row{display:flex;gap:8px}
  .muted-note{font-size:13px;color:var(--muted)}
  .meta-line{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  @media (max-width:980px){ .app{grid-template-columns:1fr;grid-auto-rows:360px;height:92vh;padding:10px} .sidebar{order:1} .chat{order:2} .right{order:3} }
</style>
</head>
<body>
  <div class="app" id="app" aria-live="polite">
    <div class="sidebar">
      <div class="brand">
        <div class="logo">CB</div>
        <div>
          <h1>ChatBox</h1>
          <div class="small muted">Enhanced demo â€” local only</div>
        </div>
      </div>

      <div class="search">
        <input id="searchInput" placeholder="Search rooms or IDs" />
        <button class="pill" id="newRoomBtn" title="Create new room">+ New</button>
      </div>

      <div class="list" id="roomsList" role="list" aria-label="Rooms"></div>

      <div style="margin-top:auto;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="small">Logged as <span id="meTag" class="muted">(not signed)</span></div>
        <div>
          <button class="pill" id="btnProfile">Profile</button>
          <button class="pill" id="btnLogout">Logout</button>
        </div>
      </div>
    </div>

    <div class="chat" id="chat">
      <div class="chat-head">
        <div>
          <div id="roomTitle" style="font-weight:700">Welcome</div>
          <div class="small muted" id="roomSub">Select or create a room to start</div>
        </div>
        <div class="row">
          <div class="pill small">Online: <span id="onlineCount">0</span></div>
          <div class="pill small" id="themeToggle" title="Toggle theme">Theme</div>
        </div>
      </div>

      <div class="messages" id="messages" tabindex="0" aria-live="polite"></div>

      <div class="composer">
        <input id="fileAttach" type="file" accept="image/*" style="display:none" />
        <textarea id="messageInput" placeholder="Type a message... (enter to send)"></textarea>
        <button class="btn" id="attachBtn" title="Attach image">ðŸ“Ž</button>
        <button class="btn" id="sendBtn">Send</button>
      </div>
    </div>

    <div class="right">
      <div class="profile">
        <div class="avatar" id="profileAvatar">?</div>
        <div>
          <div id="profileEmail">Not signed</div>
          <div class="small muted" id="profileNameNote">Tap Profile to edit</div>
        </div>
      </div>

      <div>
        <div class="small muted">Room info</div>
        <div id="roomInfo" class="muted-note">No room selected</div>
        <div style="margin-top:8px" id="roomActions"></div>
      </div>

      <div style="margin-top:auto">
        <div class="small muted">App controls</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="pill" id="exportBtn">Export</button>
          <button class="pill" id="importBtn">Import</button>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH / MODALS -->
  <div class="overlay" id="authOverlay" style="display:flex">
    <div class="panel" id="authPanel">
      <h2 id="panelTitle">Welcome to ChatBox</h2>
      <div class="muted-note">Create an account with email (demo only). Passwords hashed in-browser.</div>

      <div id="authArea" style="margin-top:12px">
        <div class="field">
          <label>Email</label>
          <input id="emailInput" type="email" placeholder="you@example.com" />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="pwInput" type="password" placeholder="choose a password" />
        </div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
          <button class="btn" id="signupBtn">Sign up</button>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:space-between;align-items:center">
          <button class="pill" id="gotoLogin">Already have account</button>
          <div class="muted-note">Tip: open multiple tabs to simulate multiple users.</div>
        </div>
      </div>

      <div id="loginArea" style="display:none;margin-top:12px">
        <div class="field"><label>Email</label><input id="loginEmail" type="email" /></div>
        <div class="field"><label>Password</label><input id="loginPw" type="password" /></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="loginBtn">Login</button>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-start">
          <button class="pill" id="gotoSignup">Create new</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create / Edit Room Modal -->
  <div class="overlay" id="roomModal" style="display:none">
    <div class="panel" role="dialog" aria-modal="true">
      <h3 id="roomModalTitle">Create a room</h3>
      <div class="field"><label>Room name</label><input id="roomName" placeholder="e.g. Football chat" /></div>
      <div class="field"><label>Custom room id (optional, letters/numbers/-)</label><input id="roomCustomId" placeholder="leave empty to auto-generate" /></div>
      <div class="field"><label>Description</label><textarea id="roomDesc" rows="3" placeholder="Short description"></textarea></div>
      <div class="field"><label>Room password (optional)</label><input id="roomPw" placeholder="optional" /></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="pill" id="cancelRoom">Cancel</button>
        <button class="btn" id="saveRoom">Save</button>
      </div>
    </div>
  </div>

<script>
/*
  Enhanced ChatBox prototype (single-file)
  - Users, rooms, messages stored in localStorage
  - Uses BroadcastChannel/localStorage for cross-tab sync
  - Avatar upload stored as base64 (demo). In prod use backend storage.
  - Room model: { id, name, desc, ownerEmail, password?, members:[] }
*/

// Storage keys
const DB_USERS = 'chatbox_users_v2';
const DB_MSGS = 'chatbox_msgs_v2';
const DB_ROOMS = 'chatbox_rooms_v2';
const CHANNEL = 'chatbox_channel_v2';

// Broadcast
const bc = ('BroadcastChannel' in window) ? new BroadcastChannel(CHANNEL) : null;
if(!bc){
  window.addEventListener('storage', (ev) => {
    if(ev.key === 'chatbox_last_event_v2') {
      const d = JSON.parse(ev.newValue || '{}');
      handleIncoming(d);
    }
  });
} else {
  bc.onmessage = ev => handleIncoming(ev.data);
}
function broadcast(type, payload){ const data={type,payload,time:new Date().toISOString()}; try{ if(bc) bc.postMessage(data); else localStorage.setItem('chatbox_last_event_v2', JSON.stringify(data)); }catch(e){} }

// Helpers
const $ = id => document.getElementById(id);
const nowISO = ()=> new Date().toISOString();
const genId = (pref='r') => pref + '-' + Math.random().toString(36).slice(2,9);
function loadJSON(key, fallback){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch(e){ return fallback; } }
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

// Simple SHA-256 hash (for demo)
async function hashStr(s){
  try{
    const enc = new TextEncoder();
    const data = enc.encode(s);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }catch(e){
    return btoa(s).slice(0,64);
  }
}

// Escape helper
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// State
let state = { me: null, currentRoom: null };

// DOM refs
const roomsList = $('roomsList'), messagesEl = $('messages'), messageInput = $('messageInput'), sendBtn = $('sendBtn');
const meTag = $('meTag'), profileAvatar = $('profileAvatar'), profileEmail = $('profileEmail'), profileNameNote = $('profileNameNote');
const roomInfo = $('roomInfo'), roomActions = $('roomActions'), roomTitle = $('roomTitle'), roomSub = $('roomSub');
const onlineCount = $('onlineCount');

// Init: seed general room if none
(function init(){
  if(!localStorage.getItem(DB_ROOMS)){
    const welcome = { id: 'room-general', name: 'General', desc: 'Public room for everyone', ownerEmail: 'system', created: nowISO(), members: [] };
    saveJSON(DB_ROOMS, [welcome]);
  }
  if(!localStorage.getItem(DB_MSGS)){
    saveJSON(DB_MSGS, [{ id: genId('m'), roomId: 'room-general', from: 'system', text: 'Welcome to the enhanced ChatBox! Create rooms and upload avatars.', time: nowISO() }]);
  }
  bindUI();
  renderRooms();
  // resume last user if exists
  const last = localStorage.getItem('chatbox_last_user_v2');
  if(last){
    const users = loadJSON(DB_USERS, []);
    const u = users.find(x=>x.email === last);
    if(u) state.me = { email: u.email, name: u.name, avatar: u.avatar };
  }
  renderAuthState();
  setTimeout(()=> { const rooms = loadJSON(DB_ROOMS, []); if(rooms.length) selectRoom(rooms[0].id); }, 250);
})();

// Incoming events
function handleIncoming(data){
  if(!data || !data.type) return;
  if(data.type === 'new_msg' || data.type === 'rooms_updated' || data.type === 'user_update'){
    renderRooms(); if(state.currentRoom) renderMessages(); renderAuthState();
  }
}

// UI binding
function bindUI(){
  $('signupBtn').addEventListener('click', signUp);
  $('gotoLogin').addEventListener('click', ()=>{ $('authArea').style.display='none'; $('loginArea').style.display='block'; $('panelTitle').textContent='Login'; });
  $('gotoSignup').addEventListener('click', ()=>{ $('authArea').style.display='block'; $('loginArea').style.display='none'; $('panelTitle').textContent='Create account'; });
  $('loginBtn').addEventListener('click', login);
  $('newRoomBtn').addEventListener('click', ()=> openRoomModal('create'));
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
  $('btnLogout').addEventListener('click', ()=> { if(confirm('Logout?')) { logout(); } });
  $('btnProfile').addEventListener('click', openProfileEditor);
  $('exportBtn').addEventListener('click', exportData);
  $('importBtn').addEventListener('click', importData);
  $('searchInput').addEventListener('input', ()=> renderRooms($('searchInput').value.trim().toLowerCase()));
  $('attachBtn').addEventListener('click', ()=> $('fileAttach').click());
  $('fileAttach').addEventListener('change', handleFileAttach);
  $('themeToggle').addEventListener('click', toggleTheme);

  // room modal buttons
  $('cancelRoom').addEventListener('click', ()=> $('roomModal').style.display='none');
  $('saveRoom').addEventListener('click', saveRoomFromModal);

  // overlay auth area
  document.getElementById('authOverlay').addEventListener('click', (e)=> { if(e.target === e.currentTarget) {/* keep auth open */} });
}

// AUTH
async function signUp(){
  const email = $('emailInput').value.trim().toLowerCase();
  const pw = $('pwInput').value;
  if(!email || !pw){ alert('Provide email and password'); return; }
  const users = loadJSON(DB_USERS, []);
  if(users.some(u=>u.email===email)){ alert('Email exists. Login instead.'); return; }
  const pwHash = await hashStr(pw);
  const user = { email, name: email.split('@')[0], pwHash, avatar: null, created: nowISO() };
  users.push(user); saveJSON(DB_USERS, users);
  state.me = { email: user.email, name: user.name, avatar: user.avatar };
  localStorage.setItem('chatbox_last_user_v2', user.email);
  $('authOverlay').style.display = 'none';
  broadcast('user_update', { email: user.email });
  renderAuthState();
}

async function login(){
  const email = $('loginEmail').value.trim().toLowerCase();
  const pw = $('loginPw').value;
  if(!email || !pw){ alert('Provide email and password'); return; }
  const users = loadJSON(DB_USERS, []);
  const u = users.find(x=>x.email === email);
  if(!u){ alert('No account found'); return; }
  const h = await hashStr(pw);
  if(h !== u.pwHash){ alert('Wrong password'); return; }
  state.me = { email: u.email, name: u.name, avatar: u.avatar };
  localStorage.setItem('chatbox_last_user_v2', u.email);
  $('authOverlay').style.display = 'none';
  renderAuthState();
  broadcast('user_update', { email: u.email });
}

function logout(){
  state.me = null;
  localStorage.removeItem('chatbox_last_user_v2');
  $('authOverlay').style.display = 'flex';
  renderAuthState();
  broadcast('user_update', {});
}

function renderAuthState(){
  meTag.textContent = state.me ? state.me.email : '(not signed)';
  profileEmail.textContent = state.me ? state.me.email : 'Not signed';
  profileNameNote.textContent = state.me ? state.me.name : 'Tap Profile to edit';
  profileAvatar.textContent = '?';
  if(state.me && state.me.avatar) {
    profileAvatar.style.backgroundImage = `url(${state.me.avatar})`;
    profileAvatar.style.backgroundSize = 'cover';
    profileAvatar.textContent = '';
  } else {
    profileAvatar.style.backgroundImage = '';
    profileAvatar.textContent = state.me ? state.me.name.slice(0,2).toUpperCase() : '?';
  }
  // hide auth overlay when signed in
  $('authOverlay').style.display = state.me ? 'none' : 'flex';
}

// ROOMS
function loadRooms(){ return loadJSON(DB_ROOMS, []); }
function saveRooms(r){ saveJSON(DB_ROOMS, r); broadcast('rooms_updated', {}); }

function renderRooms(filter=''){
  const rooms = loadRooms();
  roomsList.innerHTML = '';
  const msgs = loadJSON(DB_MSGS, []);
  // Build a map of last time
  const lastMap = {};
  msgs.forEach(m => { lastMap[m.roomId] = lastMap[m.roomId] ? (m.time > lastMap[m.roomId] ? m.time : lastMap[m.roomId]) : m.time; });
  // Sort rooms by last activity desc
  rooms.sort((a,b) => (lastMap[b.id]||b.created||'') .localeCompare(lastMap[a.id]||a.created||''));
  rooms.forEach(r => {
    if(filter){
      const s = (r.name + ' ' + r.id + ' ' + (r.desc||'')).toLowerCase();
      if(!s.includes(filter)) return;
    }
    const div = document.createElement('div'); div.className = 'room-item'; div.dataset.room = r.id;
    const av = document.createElement('div'); av.className = 'avatar'; av.textContent = r.name ? r.name.slice(0,2).toUpperCase() : r.id.slice(0,2).toUpperCase();
    const meta = document.createElement('div'); meta.className = 'room-meta';
    const title = document.createElement('div'); title.textContent = r.name || r.id; title.style.fontWeight = 700;
    const sub = document.createElement('div'); sub.className = 'small muted'; sub.textContent = r.desc ? (r.desc.length>60? r.desc.slice(0,57)+'...': r.desc) : 'No description';
    const owner = document.createElement('div'); owner.className = 'small'; owner.textContent = 'owner: '+(r.ownerEmail||'system');
    meta.appendChild(title); meta.appendChild(sub); meta.appendChild(owner);
    div.appendChild(av); div.appendChild(meta);
    div.addEventListener('click', ()=> selectRoom(r.id));
    roomsList.appendChild(div);
  });
}

// ROOM modal open/save
let roomModalMode = 'create'; // or 'edit'
let editingRoomId = null;
function openRoomModal(mode='create', roomId=null){
  roomModalMode = mode; editingRoomId = roomId;
  $('roomModal').style.display = 'flex';
  $('roomModalTitle').textContent = mode === 'create' ? 'Create a room' : 'Edit room';
  if(mode === 'edit' && roomId){
    const rooms = loadRooms(); const r = rooms.find(x=>x.id===roomId);
    if(r){ $('roomName').value = r.name || ''; $('roomCustomId').value = r.id || ''; $('roomDesc').value = r.desc || ''; $('roomPw').value = r.password || ''; }
  } else {
    $('roomName').value = ''; $('roomCustomId').value = ''; $('roomDesc').value = ''; $('roomPw').value = '';
  }
}

function saveRoomFromModal(){
  const name = $('roomName').value.trim();
  let custom = $('roomCustomId').value.trim();
  const desc = $('roomDesc').value.trim();
  const pw = $('roomPw').value.trim();
  const rooms = loadRooms();
  if(custom){
    // normalize
    custom = custom.replace(/[^a-zA-Z0-9\-\_]/g, '').toLowerCase();
    if(rooms.some(r=>r.id === custom) && (roomModalMode==='create' || editingRoomId !== custom)){
      alert('Room id taken. Choose another custom id or leave empty.');
      return;
    }
  } else {
    custom = genId('room'); // generate
  }
  const owner = state.me ? state.me.email : 'system';
  if(roomModalMode === 'create'){
    const r = { id: custom, name: name || custom, desc, password: pw || '', ownerEmail: owner, created: nowISO(), members: [] };
    rooms.push(r); saveRooms(rooms);
    // create a system message note
    const msgs = loadJSON(DB_MSGS, []);
    msgs.push({ id: genId('m'), roomId: r.id, from: 'system', text: `Room "${r.name}" created. ID: ${r.id}`, time: nowISO() });
    saveJSON(DB_MSGS, msgs);
    $('roomModal').style.display = 'none';
    renderRooms(); selectRoom(r.id);
  } else {
    // edit existing
    const r = rooms.find(x=>x.id === editingRoomId);
    if(!r){ alert('Room not found'); return; }
    r.name = name || r.name; r.desc = desc; r.password = pw || r.password;
    // if user provided a different custom id and allowed, implement rename (here we keep id stable for simplicity)
    saveRooms(rooms);
    $('roomModal').style.display = 'none';
    renderRooms(); selectRoom(r.id);
  }
}

// ROOM selection & actions
function selectRoom(id){
  const rooms = loadRooms(); const r = rooms.find(x=>x.id === id);
  if(!r){ alert('Room not found'); return; }
  state.currentRoom = id;
  // if user not member and wants to join, allow Join
  renderMessages();
  renderRoomPanel();
}

function renderRoomPanel(){
  if(!state.currentRoom){ roomInfo.textContent = 'No room selected'; roomActions.innerHTML = ''; roomTitle.textContent = 'Welcome'; roomSub.textContent = 'Select or create a room to start'; return; }
  const rooms = loadRooms(); const r = rooms.find(x=>x.id===state.currentRoom);
  if(!r) return;
  roomTitle.textContent = r.name || r.id;
  const msgs = loadJSON(DB_MSGS, []).filter(m=>m.roomId===r.id);
  roomSub.textContent = msgs.length ? msgs.length + ' messages' : 'No messages yet';
  roomInfo.innerHTML = `<strong>ID:</strong> ${r.id}<br><strong>Owner:</strong> ${r.ownerEmail || 'system'}<br><strong>Description:</strong> ${escapeHtml(r.desc||'No description')}`;
  // actions
  roomActions.innerHTML = '';
  const joinBtn = document.createElement('button'); joinBtn.className='pill'; joinBtn.textContent = 'Join Room';
  joinBtn.addEventListener('click', ()=> joinRoom(r.id));
  const copyBtn = document.createElement('button'); copyBtn.className='pill'; copyBtn.textContent = 'Copy ID';
  copyBtn.addEventListener('click', ()=> { navigator.clipboard?.writeText(r.id); alert('Copied: '+r.id); });
  roomActions.appendChild(joinBtn); roomActions.appendChild(copyBtn);
  // owner-only actions
  if(state.me && state.me.email === r.ownerEmail){
    const editBtn = document.createElement('button'); editBtn.className='pill'; editBtn.textContent = 'Edit';
    editBtn.addEventListener('click', ()=> openRoomModal('edit', r.id));
    const delBtn = document.createElement('button'); delBtn.className='pill'; delBtn.textContent = 'Delete';
    delBtn.addEventListener('click', ()=> {
      if(confirm('Delete room and its messages? This is permanent (local demo).')){
        deleteRoom(r.id);
      }
    });
    roomActions.appendChild(editBtn); roomActions.appendChild(delBtn);
  }
  // show simple member list
  const members = r.members && r.members.length ? r.members.join(', ') : '(no members)';
  const memDiv = document.createElement('div'); memDiv.className='small muted'; memDiv.style.marginTop='8px'; memDiv.textContent = 'Members: '+members;
  roomActions.appendChild(memDiv);
}

// Join room (simple membership)
function joinRoom(id){
  if(!state.me){ alert('Sign in to join'); return; }
  const rooms = loadRooms(); const r = rooms.find(x=>x.id===id);
  if(!r) return;
  if(!r.members) r.members = [];
  if(!r.members.includes(state.me.email)) r.members.push(state.me.email);
  saveRooms(rooms);
  renderRoomPanel();
  broadcast('rooms_updated', {});
  alert('Joined room: '+r.name);
}

// Delete room
function deleteRoom(id){
  let rooms = loadRooms();
  rooms = rooms.filter(r => r.id !== id);
  saveRooms(rooms);
  // also delete messages
  let msgs = loadJSON(DB_MSGS, []);
  msgs = msgs.filter(m => m.roomId !== id);
  saveJSON(DB_MSGS, msgs);
  if(state.currentRoom === id) state.currentRoom = null;
  renderRooms(); renderMessages(); renderRoomPanel();
  broadcast('rooms_updated', {});
}

// MESSAGES
function renderMessages(){
  messagesEl.innerHTML = '';
  if(!state.currentRoom){ messagesEl.innerHTML = '<div class="muted-note">Select a room to see messages</div>'; return; }
  const msgs = loadJSON(DB_MSGS, []).filter(m=>m.roomId===state.currentRoom);
  msgs.forEach(m => {
    const el = document.createElement('div');
    const isMe = state.me && m.from === state.me.email;
    el.className = 'msg ' + (isMe ? 'me' : 'others');
    const fromLine = document.createElement('div'); fromLine.className='from'; fromLine.textContent = m.from;
    const text = document.createElement('div'); text.innerHTML = (m.image ? `<img src="${m.image}" style="max-width:300px;border-radius:8px;display:block;margin-bottom:6px">` : '') + escapeHtml(m.text);
    const time = document.createElement('div'); time.className='time'; time.textContent = (new Date(m.time)).toLocaleString();
    el.appendChild(fromLine); el.appendChild(text); el.appendChild(time);
    messagesEl.appendChild(el);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Sending message
function sendMessage(){
  const txt = messageInput.value.trim();
  if(!txt && !pendingImage) return;
  if(!state.currentRoom){ alert('Select a room first'); return; }
  if(!state.me){ alert('Sign in to send messages'); return; }
  // ensure membership
  const rooms = loadRooms(); const r = rooms.find(x=>x.id === state.currentRoom);
  if(r && r.password && !r.members.includes(state.me.email) && state.me.email !== r.ownerEmail){
    const pw = prompt('Room is protected. Enter password:');
    if(pw !== r.password) { alert('Wrong password'); return; }
  }
  if(r && !r.members.includes(state.me.email)) r.members.push(state.me.email), saveRooms(rooms);
  const msgs = loadJSON(DB_MSGS, []);
  const m = { id: genId('m'), roomId: state.currentRoom, from: state.me.email, text: txt, time: nowISO(), image: pendingImage || null };
  msgs.push(m); saveJSON(DB_MSGS, msgs);
  pendingImage = null; $('fileAttach').value = '';
  messageInput.value = '';
  renderMessages();
  broadcast('new_msg', { room: state.currentRoom, id: m.id });
}

// File attach (image)
let pendingImage = null;
function handleFileAttach(e){
  const f = e.target.files[0];
  if(!f) return;
  if(!f.type.startsWith('image/')){ alert('Only images supported (demo).'); return; }
  const reader = new FileReader();
  reader.onload = () => { pendingImage = reader.result; alert('Image attached â€” send message to include it'); };
  reader.readAsDataURL(f);
}

// PROFILE editor (name/avatar)
function openProfileEditor(){
  if(!state.me){ $('authOverlay').style.display='flex'; return; }
  const name = prompt('Display name', state.me.name) || state.me.name;
  // avatar upload via prompt (data URL) or choose file - we'll show simple file input dialog
  const changeAvatar = confirm('Change avatar image? (OK to open file chooser)');
  if(changeAvatar){
    const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange = (ev)=> {
      const f = ev.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = () => {
        const b64 = r.result;
        saveProfile(state.me.email, name, b64);
      };
      r.readAsDataURL(f);
    };
    inp.click();
  } else {
    saveProfile(state.me.email, name, state.me.avatar || null);
  }
}

function saveProfile(email, name, avatar){
  const users = loadJSON(DB_USERS, []);
  const u = users.find(x=>x.email === email);
  if(u){ u.name = name; u.avatar = avatar; saveJSON(DB_USERS, users); state.me = { email, name, avatar }; renderAuthState(); broadcast('user_update', { email }); alert('Profile updated'); }
}

// EXPORT / IMPORT
function exportData(){
  const data = { users: loadJSON(DB_USERS, []), rooms: loadRooms(), msgs: loadJSON(DB_MSGS, []) };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'chatbox-export.json'; a.click(); URL.revokeObjectURL(url);
}
function importData(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = (ev)=> {
    const f = ev.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try{
        const obj = JSON.parse(r.result);
        if(obj.users) saveJSON(DB_USERS, obj.users);
        if(obj.rooms) saveJSON(DB_ROOMS, obj.rooms);
        if(obj.msgs) saveJSON(DB_MSGS, obj.msgs);
        alert('Imported');
        renderRooms(); if(state.currentRoom) renderMessages();
        broadcast('rooms_updated', {});
      }catch(e){ alert('Invalid file'); }
    };
    r.readAsText(f);
  };
  inp.click();
}

// Theme toggle (swap accents)
function toggleTheme(){
  const a = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  if(a === '#7c3aed') {
    document.documentElement.style.setProperty('--accent', '#06b6d4');
    document.documentElement.style.setProperty('--accent2', '#7c3aed');
  } else {
    document.documentElement.style.setProperty('--accent', '#7c3aed');
    document.documentElement.style.setProperty('--accent2', '#06b6d4');
  }
}

// Utility: load messages for current room only
function joinDefaultIfNeeded(){
  if(!state.currentRoom){
    const rooms = loadRooms(); if(rooms.length) selectRoom(rooms[0].id);
  }
}

// Simple online count (unique senders in recent messages)
function updateOnlineCount(){
  const msgs = loadJSON(DB_MSGS, []);
  const recent = msgs.slice(-200);
  const users = {};
  recent.forEach(m => { if(m.from && m.from !== 'system') users[m.from] = true; });
  onlineCount.textContent = Object.keys(users).length;
}

// periodic UI refreshes for cross-tab updates
setInterval(()=> { renderRooms(); renderMessages(); renderRoomPanel(); updateOnlineCount(); }, 2000);

// Render flow helpers
function loadJSON(key, fallback){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch(e){ return fallback; } }
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

// keep some global handles for debugging
window._chatbox_v2 = {
  loadUsers: ()=> loadJSON(DB_USERS, []),
  loadRooms: ()=> loadRooms(),
  loadMsgs: ()=> loadJSON(DB_MSGS, []),
  saveRooms, saveJSON, genId
};
</script>
</body>
            </html>
