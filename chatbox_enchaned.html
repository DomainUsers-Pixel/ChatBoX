<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChatBox — Enhanced v1.2 (Private Rooms + Fancy Modal)</title>
<style>
  :root{
    --bg:#071826; --card:#0b1520; --accent:#7c3aed; --accent2:#06b6d4; --muted:#94a3b8;
    --glass: rgba(255,255,255,0.03); --radius:12px; --btn-gap:8px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;color:#e6eef8;background:linear-gradient(180deg,#071023 0%, #071a2d 100%);}
  .app{max-width:1200px;margin:20px auto;height:86vh;border-radius:14px;display:grid;grid-template-columns:280px 1fr 320px;gap:16px;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 30px rgba(2,6,23,0.7);}
  /* SIDEBAR */
  .sidebar{background:var(--card);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700}
  .brand h1{font-size:16px;margin:0}
  .search{padding:8px;border-radius:10px;background:var(--glass);display:flex;gap:8px;align-items:center}
  .search input{flex:1;background:transparent;border:0;outline:none;color:var(--muted)}
  .list{overflow:auto;padding-right:6px;max-height:54vh}
  .room-item{display:flex;align-items:flex-start;gap:10px;padding:10px;border-radius:10px;cursor:pointer;transition:transform .12s, background .12s}
  .room-item:hover{transform:translateY(-3px);background:rgba(255,255,255,0.02)}
  .room-item .avatar{width:44px;height:44px;border-radius:8px;background:#0e2030;display:flex;align-items:center;justify-content:center;font-weight:700}
  .room-meta{flex:1}
  .small{font-size:13px;color:var(--muted)}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px}
  /* CHAT */
  .chat{background:var(--card);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;overflow:hidden}
  .chat-head{display:flex;align-items:center;justify-content:space-between;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
  .msg{max-width:72%;padding:10px;border-radius:10px;line-height:1.3;word-wrap:break-word;box-shadow:0 6px 14px rgba(2,6,23,0.5)}
  .msg.me{align-self:flex-end;background:linear-gradient(180deg,#3b82f6,#60a5fa);color:#021124;border-bottom-right-radius:4px}
  .msg.others{align-self:flex-start;background:rgba(255,255,255,0.03)}
  .msg .from{font-size:12px;color:var(--muted);margin-bottom:6px}
  .msg .time{font-size:11px;color:var(--muted);margin-top:8px;text-align:right}
  .composer{display:flex;gap:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.02)}
  .composer textarea{flex:1;padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.02);color:inherit;resize:none;height:58px}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:0;padding:10px 14px;border-radius:10px;color:white;cursor:pointer;box-shadow:0 6px 20px rgba(124,58,237,0.12)}
  .btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(124,58,237,0.18)}
  /* pill buttons (profile/logout/etc) -> make gradient too */
  .pill-btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:0;padding:8px 10px;border-radius:999px;color:white;cursor:pointer;font-size:13px;box-shadow:0 6px 18px rgba(6,182,212,0.06)}
  .pill-btn:hover{transform:translateY(-2px)}
  /* RIGHT PANEL */
  .right{background:var(--card);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:12px;overflow:auto}
  .profile{display:flex;gap:12px;align-items:center}
  .profile .avatar{width:56px;height:56px;border-radius:12px;background:#092036;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px}
  .muted{color:var(--muted);font-size:14px}
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.65);display:none;align-items:center;justify-content:center;z-index:400;backdrop-filter: blur(6px);}
  .panel{width:480px;background:linear-gradient(180deg,#06111b,#071826);padding:18px;border-radius:12px;box-shadow:0 15px 40px rgba(2,6,23,0.7)}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .field input, .field textarea, .field select{padding:10px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit;outline:none}
  .row{display:flex;gap:8px}
  .muted-note{font-size:13px;color:var(--muted)}
  .meta-line{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  /* fancy private modal specifics */
  .private-modal .modal-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .lock-badge{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;box-shadow:0 10px 30px rgba(124,58,237,0.18)}
  .fancy-title{font-weight:700;font-size:18px}
  .toast{position:fixed;right:20px;bottom:24px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;padding:10px 14px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.6);z-index:600;opacity:0;transform:translateY(6px);transition:all .28s}
  .toast.show{opacity:1;transform:translateY(0)}
  .lock-icon{margin-left:8px}
  @media (max-width:980px){ .app{grid-template-columns:1fr;grid-auto-rows:360px;height:92vh;padding:10px} .sidebar{order:1} .chat{order:2} .right{order:3} }
</style>
</head>
<body>
  <div class="app" id="app" aria-live="polite">
    <div class="sidebar">
      <div class="brand">
        <div class="logo">CB</div>
        <div>
          <h1>ChatBox</h1>
          <div class="small muted">Enhanced demo — local only</div>
        </div>
      </div>

      <div class="search">
        <input id="searchInput" placeholder="Search rooms or IDs" />
        <button class="pill-btn" id="newRoomBtn" title="Create new room">+ New</button>
      </div>

      <div class="list" id="roomsList" role="list" aria-label="Rooms"></div>

      <div style="margin-top:auto;display:flex;gap:var(--btn-gap);align-items:center;justify-content:space-between">
        <div class="small">Logged as <span id="meTag" class="muted">(not signed)</span></div>
        <div style="display:flex;gap:8px">
          <button class="pill-btn" id="btnProfile">Profile</button>
          <button class="pill-btn" id="btnLogout">Logout</button>
        </div>
      </div>
    </div>

    <div class="chat" id="chat">
      <div class="chat-head">
        <div>
          <div id="roomTitle" style="font-weight:700">Welcome</div>
          <div class="small muted" id="roomSub">Select or create a room to start</div>
        </div>
        <div class="row">
          <div class="pill small">Online: <span id="onlineCount">0</span></div>
          <div class="pill small pill-btn" id="themeToggle" title="Toggle theme">Theme</div>
        </div>
      </div>

      <div class="messages" id="messages" tabindex="0" aria-live="polite"></div>

      <div class="composer">
        <input id="fileAttach" type="file" accept="image/*" style="display:none" />
        <textarea id="messageInput" placeholder="Type a message... (enter to send)"></textarea>
        <button class="btn" id="attachBtn" title="Attach image">📎</button>
        <button class="btn" id="sendBtn">Send</button>
      </div>
    </div>

    <div class="right">
      <div class="profile">
        <div class="avatar" id="profileAvatar">?</div>
        <div>
          <div id="profileEmail">Not signed</div>
          <div class="small muted" id="profileNameNote">Tap Profile to edit</div>
        </div>
      </div>

      <div>
        <div class="small muted">Room info</div>
        <div id="roomInfo" class="muted-note">No room selected</div>
        <div style="margin-top:8px" id="roomActions"></div>
      </div>

      <div style="margin-top:auto">
        <div class="small muted">App controls</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="pill-btn" id="exportBtn">Export</button>
          <button class="pill-btn" id="importBtn">Import</button>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH / MODALS -->
  <div class="overlay" id="authOverlay" style="display:flex">
    <div class="panel" id="authPanel">
      <h2 id="panelTitle">Welcome to ChatBox</h2>
      <div class="muted-note">Create an account with email (demo only). Passwords hashed in-browser.</div>

      <div id="authArea" style="margin-top:12px">
        <div class="field">
          <label>Email</label>
          <input id="emailInput" type="email" placeholder="you@example.com" />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="pwInput" type="password" placeholder="choose a password" />
        </div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
          <button class="btn" id="signupBtn">Sign up</button>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:space-between;align-items:center">
          <button class="pill-btn" id="gotoLogin">Already have account</button>
          <div class="muted-note">Tip: open multiple tabs to simulate multiple users.</div>
        </div>
      </div>

      <div id="loginArea" style="display:none;margin-top:12px">
        <div class="field"><label>Email</label><input id="loginEmail" type="email" /></div>
        <div class="field"><label>Password</label><input id="loginPw" type="password" /></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="loginBtn">Login</button>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-start">
          <button class="pill-btn" id="gotoSignup">Create new</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create / Edit Room Modal -->
  <div class="overlay" id="roomModal" style="display:none">
    <div class="panel" role="dialog" aria-modal="true">
      <h3 id="roomModalTitle">Create a room</h3>
      <div class="field"><label>Room name</label><input id="roomName" placeholder="e.g. Football chat" /></div>
      <div class="field"><label>Custom room id (optional, letters/numbers/-)</label><input id="roomCustomId" placeholder="leave empty to auto-generate" /></div>
      <div class="field"><label>Description</label><textarea id="roomDesc" rows="3" placeholder="Short description"></textarea></div>
      <div class="field"><label>Room password (optional)</label><input id="roomPw" placeholder="optional" /></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="pill-btn" id="cancelRoom">Cancel</button>
        <button class="btn" id="saveRoom">Save</button>
      </div>
    </div>
  </div>

  <!-- Fancy Private Room Modal -->
  <div class="overlay" id="privateModal" style="display:none">
    <div class="panel private-modal" role="dialog" aria-modal="true" aria-labelledby="privateTitle">
      <div class="modal-header">
        <div class="lock-badge">🔒</div>
        <div>
          <div id="privateTitle" class="fancy-title">Private Room Access</div>
          <div class="small muted" id="privateSubtitle">Enter password to unlock the room</div>
        </div>
      </div>

      <div class="field">
        <label>Room</label>
        <input id="privateRoomName" readonly />
      </div>
      <div class="field">
        <label>Room ID</label>
        <input id="privateRoomId" readonly />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="privateRoomPw" type="password" placeholder="Room password" />
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="pill-btn" id="privateCancel">Cancel</button>
        <button class="btn" id="privateUnlock">Unlock Room</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* v1.2 update:
   - Fancy password modal for private rooms (on open & join)
   - Gradient styling for pill buttons (profile/logout/theme/export/import)
   - Lock icon next to private rooms
   - Access caching in localStorage until logout
   - Toast notifications
*/

// Storage keys
const DB_USERS = 'chatbox_users_v2';
const DB_MSGS = 'chatbox_msgs_v2';
const DB_ROOMS = 'chatbox_rooms_v2';
const DB_ACCESS = 'chatbox_access_v2'; // { roomId: true }
const CHANNEL = 'chatbox_channel_v2';

// Broadcast (cross-tab)
const bc = ('BroadcastChannel' in window) ? new BroadcastChannel(CHANNEL) : null;
if(!bc){
  window.addEventListener('storage', (ev) => {
    if(ev.key === 'chatbox_last_event_v2') {
      const d = JSON.parse(ev.newValue || '{}');
      handleIncoming(d);
    }
  });
} else {
  bc.onmessage = ev => handleIncoming(ev.data);
}
function broadcast(type, payload){ const data={type,payload,time:new Date().toISOString()}; try{ if(bc) bc.postMessage(data); else localStorage.setItem('chatbox_last_event_v2', JSON.stringify(data)); }catch(e){} }

const $ = id => document.getElementById(id);
const nowISO = ()=> new Date().toISOString();
const genId = (pref='r') => pref + '-' + Math.random().toString(36).slice(2,9);

function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch(e){ return fallback; } }
function save(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); }

// Toast helper
function toast(msg, t=2800){
  const el = $('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(()=> el.classList.remove('show'), t);
}

// Escape
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

let state = { me: null, currentRoom: null };

// Init
(function init(){
  if(!localStorage.getItem(DB_ROOMS)){
    const welcome = { id: 'room-general', name: 'General', desc: 'Public room for everyone', ownerEmail: 'system', created: nowISO(), members: [] };
    save(DB_ROOMS,[welcome]);
  }
  if(!localStorage.getItem(DB_MSGS)){
    save(DB_MSGS,[{ id: genId('m'), roomId: 'room-general', from: 'system', text: 'Welcome to ChatBox v1.2 — Try creating private rooms!', time: nowISO() }]);
  }
  if(!localStorage.getItem(DB_ACCESS)) save(DB_ACCESS,{});
  bindUI();
  renderRooms();
  const last = localStorage.getItem('chatbox_last_user_v2');
  if(last){
    const users = load(DB_USERS,[]);
    const u = users.find(x=>x.email === last);
    if(u) state.me = { email: u.email, name: u.name, avatar: u.avatar };
  }
  renderAuthState();
  setTimeout(()=> { const rooms = load(DB_ROOMS, []); if(rooms.length) selectRoom(rooms[0].id); }, 250);
})();

function handleIncoming(data){
  if(!data || !data.type) return;
  if(data.type === 'new_msg' || data.type === 'rooms_updated' || data.type === 'user_update'){
    renderRooms(); if(state.currentRoom) renderMessages(); renderAuthState();
  }
}

// UI bindings
function bindUI(){
  $('signupBtn').addEventListener('click', signUp);
  $('gotoLogin').addEventListener('click', ()=>{ $('authArea').style.display='none'; $('loginArea').style.display='block'; $('panelTitle').textContent='Login'; });
  $('gotoSignup').addEventListener('click', ()=>{ $('authArea').style.display='block'; $('loginArea').style.display='none'; $('panelTitle').textContent='Create account'; });
  $('loginBtn').addEventListener('click', login);
  $('newRoomBtn').addEventListener('click', ()=> openRoomModal('create'));
  $('sendBtn').addEventListener('click', sendMessage);
  $('messageInput').addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
  $('btnLogout').addEventListener('click', ()=> { if(confirm('Logout?')) { logout(); } });
  $('btnProfile').addEventListener('click', openProfileEditor);
  $('exportBtn').addEventListener('click', exportData);
  $('importBtn').addEventListener('click', importData);
  $('searchInput').addEventListener('input', ()=> renderRooms($('searchInput').value.trim().toLowerCase()));
  $('attachBtn').addEventListener('click', ()=> $('fileAttach').click());
  $('fileAttach').addEventListener('change', handleFileAttach);
  $('themeToggle').addEventListener('click', toggleTheme);
  $('cancelRoom').addEventListener('click', ()=> $('roomModal').style.display='none');
  $('saveRoom').addEventListener('click', saveRoomFromModal);

  // private modal
  $('privateCancel').addEventListener('click', ()=> hidePrivateModal());
  $('privateUnlock').addEventListener('click', tryUnlockPrivateRoom);
}

// AUTH
async function hashStr(s){
  try{
    const enc = new TextEncoder();
    const data = enc.encode(s);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }catch(e){ return btoa(s).slice(0,64); }
}
async function signUp(){
  const email = $('emailInput').value.trim().toLowerCase();
  const pw = $('pwInput').value;
  if(!email || !pw){ alert('Provide email and password'); return; }
  const users = load(DB_USERS, []);
  if(users.some(u=>u.email===email)){ alert('Email exists. Login instead.'); return; }
  const pwHash = await hashStr(pw);
  const user = { email, name: email.split('@')[0], pwHash, avatar: null, created: nowISO() };
  users.push(user); save(DB_USERS, users);
  state.me = { email: user.email, name: user.name, avatar: user.avatar };
  localStorage.setItem('chatbox_last_user_v2', user.email);
  $('authOverlay').style.display = 'none';
  broadcast('user_update', { email: user.email });
  renderAuthState();
  toast('Signed up ✓');
}
async function login(){
  const email = $('loginEmail').value.trim().toLowerCase();
  const pw = $('loginPw').value;
  if(!email || !pw){ alert('Provide email and password'); return; }
  const users = load(DB_USERS, []);
  const u = users.find(x=>x.email === email);
  if(!u){ alert('No account found'); return; }
  const h = await hashStr(pw);
  if(h !== u.pwHash){ alert('Wrong password'); return; }
  state.me = { email: u.email, name: u.name, avatar: u.avatar };
  localStorage.setItem('chatbox_last_user_v2', u.email);
  $('authOverlay').style.display = 'none';
  renderAuthState();
  broadcast('user_update', { email: u.email });
  toast('Logged in ✓');
}
function logout(){
  state.me = null;
  localStorage.removeItem('chatbox_last_user_v2');
  // clear room access cache on logout as requested
  save(DB_ACCESS, {});
  $('authOverlay').style.display = 'flex';
  renderAuthState();
  broadcast('user_update', {});
  toast('Logged out');
}
function renderAuthState(){
  $('meTag').textContent = state.me ? state.me.email : '(not signed)';
  $('profileEmail').textContent = state.me ? state.me.email : 'Not signed';
  $('profileNameNote').textContent = state.me ? state.me.name : 'Tap Profile to edit';
  if(state.me && state.me.avatar) {
    $('profileAvatar').style.backgroundImage = `url(${state.me.avatar})`;
    $('profileAvatar').style.backgroundSize = 'cover';
    $('profileAvatar').textContent = '';
  } else {
    $('profileAvatar').style.backgroundImage = '';
    $('profileAvatar').textContent = state.me ? state.me.name.slice(0,2).toUpperCase() : '?';
  }
  $('authOverlay').style.display = state.me ? 'none' : 'flex';
}

// ROOMS
function loadRooms(){ return load(DB_ROOMS, []); }
function saveRooms(r){ save(DB_ROOMS, r); broadcast('rooms_updated', {}); }
function renderRooms(filter=''){
  const rooms = loadRooms();
  roomsList.innerHTML = '';
  const msgs = load(DB_MSGS, []);
  const lastMap = {};
  msgs.forEach(m => { lastMap[m.roomId] = lastMap[m.roomId] ? (m.time > lastMap[m.roomId] ? m.time : lastMap[m.roomId]) : m.time; });
  rooms.sort((a,b) => (lastMap[b.id]||b.created||'') .localeCompare(lastMap[a.id]||a.created||''));
  rooms.forEach(r => {
    if(filter){
      const s = (r.name + ' ' + r.id + ' ' + (r.desc||'')).toLowerCase();
      if(!s.includes(filter)) return;
    }
    const div = document.createElement('div'); div.className = 'room-item'; div.dataset.room = r.id;
    const av = document.createElement('div'); av.className = 'avatar'; av.textContent = r.name ? r.name.slice(0,2).toUpperCase() : r.id.slice(0,2).toUpperCase();
    const meta = document.createElement('div'); meta.className = 'room-meta';
    const title = document.createElement('div'); title.style.fontWeight = 700;
    title.textContent = r.name || r.id;
    // lock icon
    if(r.password) {
      const lock = document.createElement('span'); lock.className='lock-icon'; lock.textContent = ' 🔒';
      title.appendChild(lock);
    }
    const sub = document.createElement('div'); sub.className = 'small muted'; sub.textContent = r.desc ? (r.desc.length>60? r.desc.slice(0,57)+'...': r.desc) : 'No description';
    const owner = document.createElement('div'); owner.className = 'small'; owner.textContent = 'owner: '+(r.ownerEmail||'system');
    meta.appendChild(title); meta.appendChild(sub); meta.appendChild(owner);
    div.appendChild(av); div.appendChild(meta);
    // on click -> if password protected -> prompt; else open
    div.addEventListener('click', ()=> { if(r.password) showPrivateModalForRoom(r.id, r.name); else selectRoom(r.id); });
    roomsList.appendChild(div);
  });
}

// ROOM modal create/edit
let roomModalMode = 'create'; let editingRoomId = null;
function openRoomModal(mode='create', roomId=null){
  roomModalMode = mode; editingRoomId = roomId;
  $('roomModal').style.display = 'flex';
  $('roomModalTitle').textContent = mode === 'create' ? 'Create a room' : 'Edit room';
  if(mode === 'edit' && roomId){
    const rooms = loadRooms(); const r = rooms.find(x=>x.id===roomId);
    if(r){ $('roomName').value = r.name || ''; $('roomCustomId').value = r.id || ''; $('roomDesc').value = r.desc || ''; $('roomPw').value = r.password || ''; }
  } else {
    $('roomName').value = ''; $('roomCustomId').value = ''; $('roomDesc').value = ''; $('roomPw').value = '';
  }
}
function saveRoomFromModal(){
  const name = $('roomName').value.trim();
  let custom = $('roomCustomId').value.trim();
  const desc = $('roomDesc').value.trim();
  const pw = $('roomPw').value.trim();
  const rooms = loadRooms();
  if(custom){
    custom = custom.replace(/[^a-zA-Z0-9\-\_]/g, '').toLowerCase();
    if(rooms.some(r=>r.id === custom) && (roomModalMode==='create' || editingRoomId !== custom)){
      alert('Room id taken. Choose another custom id or leave empty.');
      return;
    }
  } else {
    custom = genId('room');
  }
  const owner = state.me ? state.me.email : 'system';
  if(roomModalMode === 'create'){
    const r = { id: custom, name: name || custom, desc, password: pw || '', ownerEmail: owner, created: nowISO(), members: [] };
    rooms.push(r); saveRooms(rooms);
    const msgs = load(DB_MSGS, []);
    msgs.push({ id: genId('m'), roomId: r.id, from: 'system', text: `Room "${r.name}" created. ID: ${r.id}`, time: nowISO() });
    save(DB_MSGS, msgs);
    $('roomModal').style.display = 'none';
    renderRooms(); selectRoom(r.id);
    toast('Room created ✓');
  } else {
    const r = rooms.find(x=>x.id === editingRoomId);
    if(!r){ alert('Room not found'); return; }
    r.name = name || r.name; r.desc = desc; r.password = pw || r.password;
    saveRooms(rooms);
    $('roomModal').style.display = 'none';
    renderRooms(); selectRoom(r.id);
    toast('Room updated');
  }
}

// PRIVATE ROOM modal logic
function showPrivateModalForRoom(roomId, roomName){
  const rooms = loadRooms(); const r = rooms.find(x=>x.id===roomId); if(!r) return;
  // If user already granted access, skip modal and open
  const access = load(DB_ACCESS, {});
  if(access[roomId]) return selectRoom(roomId);
  $('privateRoomName').value = r.name || r.id;
  $('privateRoomId').value = r.id;
  $('privateRoomPw').value = '';
  $('privateModal').style.display = 'flex';
}
function hidePrivateModal(){ $('privateModal').style.display = 'none'; }
function tryUnlockPrivateRoom(){
  const id = $('privateRoomId').value;
  const pw = $('privateRoomPw').value || '';
  const rooms = loadRooms(); const r = rooms.find(x=>x.id === id);
  if(!r){ alert('Room not found'); hidePrivateModal(); return; }
  if(!r.password){ // no password (shouldn't happen) -> open
    grantAccessAndOpen(id); return;
  }
  if(pw === r.password){
    grantAccessAndOpen(id);
  } else {
    toast('❌ Incorrect password', 1600);
  }
}
function grantAccessAndOpen(roomId){
  const access = load(DB_ACCESS, {});
  access[roomId] = true;
  save(DB_ACCESS, access);
  hidePrivateModal();
  // add to members if logged in
  if(state.me){
    const rooms = loadRooms(); const r = rooms.find(x=>x.id===roomId);
    if(r && !r.members.includes(state.me.email)){ r.members.push(state.me.email); saveRooms(rooms); }
  }
  selectRoom(roomId);
  toast('✅ Access granted');
}

// SELECT ROOM (click behavior)
function selectRoom(id){
  // if room is password-protected and user has not access => show modal
  const r = loadRooms().find(x=>x.id===id);
  if(!r) return;
  if(r.password){
    const access = load(DB_ACCESS, {});
    if(!access[id]){ showPrivateModalForRoom(id,r.name); return; }
  }
  state.currentRoom = id;
  renderMessages();
  renderRoomPanel();
}

// ROOM panel
function renderRoomPanel(){
  if(!state.currentRoom){ $('roomInfo').textContent = 'No room selected'; $('roomActions').innerHTML=''; $('roomTitle').textContent='Welcome'; $('roomSub').textContent='Select or create a room to start'; return; }
  const r = loadRooms().find(x=>x.id===state.currentRoom);
  if(!r) return;
  $('roomTitle').textContent = r.name || r.id;
  const msgs = load(DB_MSGS, []).filter(m=>m.roomId===r.id);
  $('roomSub').textContent = msgs.length ? msgs.length + ' messages' : 'No messages yet';
  $('roomInfo').innerHTML = `<strong>ID:</strong> ${r.id}<br><strong>Owner:</strong> ${r.ownerEmail || 'system'}<br><strong>Description:</strong> ${escapeHtml(r.desc||'No description')}`;
  const ra = $('roomActions'); ra.innerHTML = '';
  const joinBtn = document.createElement('button'); joinBtn.className='pill-btn'; joinBtn.textContent = 'Join Room';
  joinBtn.addEventListener('click', ()=> {
    if(r.password){
      const access = load(DB_ACCESS, {});
      if(access[r.id]) { toast('Already joined'); return; }
      // show modal to enter password (join)
      $('privateRoomName').value = r.name; $('privateRoomId').value = r.id; $('privateRoomPw').value = ''; $('privateModal').style.display = 'flex';
    } else {
      joinRoom(r.id);
    }
  });
  const copyBtn = document.createElement('button'); copyBtn.className='pill-btn'; copyBtn.textContent = 'Copy ID';
  copyBtn.addEventListener('click', ()=> { navigator.clipboard?.writeText(r.id); toast('Copied ID'); });
  ra.appendChild(joinBtn); ra.appendChild(copyBtn);
  if(state.me && state.me.email === r.ownerEmail){
    const editBtn = document.createElement('button'); editBtn.className='pill-btn'; editBtn.textContent = 'Edit';
    editBtn.addEventListener('click', ()=> openRoomModal('edit', r.id));
    const delBtn = document.createElement('button'); delBtn.className='pill-btn'; delBtn.textContent = 'Delete';
    delBtn.addEventListener('click', ()=> {
      if(confirm('Delete room and its messages? This is permanent (local demo).')){
        deleteRoom(r.id);
      }
    });
    ra.appendChild(editBtn); ra.appendChild(delBtn);
  }
  const members = r.members && r.members.length ? r.members.join(', ') : '(no members)';
  const memDiv = document.createElement('div'); memDiv.className='small muted'; memDiv.style.marginTop='8px'; memDiv.textContent = 'Members: '+members;
  ra.appendChild(memDiv);
}

// JOIN room for non-protected
function joinRoom(id){
  if(!state.me){ alert('Sign in to join'); return; }
  const rooms = loadRooms(); const r = rooms.find(x=>x.id===id);
  if(!r) return;
  if(!r.members) r.members = [];
  if(!r.members.includes(state.me.email)) r.members.push(state.me.email);
  saveRooms(rooms);
  renderRoomPanel();
  broadcast('rooms_updated', {});
  toast('Joined room ✓');
}

function deleteRoom(id){
  let rooms = loadRooms();
  rooms = rooms.filter(r => r.id !== id);
  saveRooms(rooms);
  let msgs = load(DB_MSGS, []);
  msgs = msgs.filter(m => m.roomId !== id);
  save(DB_MSGS, msgs);
  if(state.currentRoom === id) state.currentRoom = null;
  renderRooms(); renderMessages(); renderRoomPanel();
  broadcast('rooms_updated', {});
  toast('Room deleted');
}

// MESSAGES
function renderMessages(){
  $('messages').innerHTML = '';
  if(!state.currentRoom){ $('messages').innerHTML = '<div class="muted-note">Select a room to see messages</div>'; return; }
  const msgs = load(DB_MSGS, []).filter(m=>m.roomId===state.currentRoom);
  msgs.forEach(m => {
    const el = document.createElement('div');
    const isMe = state.me && m.from === state.me.email;
    el.className = 'msg ' + (isMe ? 'me' : 'others');
    const fromLine = document.createElement('div'); fromLine.className='from'; fromLine.textContent = m.from;
    const text = document.createElement('div'); text.innerHTML = (m.image ? `<img src="${m.image}" style="max-width:300px;border-radius:8px;display:block;margin-bottom:6px">` : '') + escapeHtml(m.text);
    const time = document.createElement('div'); time.className='time'; time.textContent = (new Date(m.time)).toLocaleString();
    el.appendChild(fromLine); el.appendChild(text); el.appendChild(time);
    $('messages').appendChild(el);
  });
  $('messages').scrollTop = $('messages').scrollHeight;
}

// Send message
let pendingImage = null;
function handleFileAttach(e){
  const f = e.target.files[0];
  if(!f) return;
  if(!f.type.startsWith('image/')){ alert('Only images supported (demo).'); return; }
  const reader = new FileReader();
  reader.onload = () => { pendingImage = reader.result; toast('Image attached — send to include'); };
  reader.readAsDataURL(f);
}
function sendMessage(){
  const txt = $('messageInput').value.trim();
  if(!txt && !pendingImage) return;
  if(!state.currentRoom){ alert('Select a room first'); return; }
  if(!state.me){ alert('Sign in to send messages'); return; }
  const rooms = loadRooms(); const r = rooms.find(x=>x.id === state.currentRoom);
  if(r && r.password && !(load(DB_ACCESS, {})[r.id]) && state.me.email !== r.ownerEmail){
    // require unlock first
    showPrivateModalForRoom(r.id, r.name);
    return;
  }
  if(r && !r.members.includes(state.me.email)) r.members.push(state.me.email), saveRooms(rooms);
  const msgs = load(DB_MSGS, []);
  const m = { id: genId('m'), roomId: state.currentRoom, from: state.me.email, text: txt, time: nowISO(), image: pendingImage || null };
  msgs.push(m); save(DB_MSGS, msgs);
  pendingImage = null; $('fileAttach').value = '';
  $('messageInput').value = '';
  renderMessages();
  broadcast('new_msg', { room: state.currentRoom, id: m.id });
}

// PROFILE editor
function openProfileEditor(){
  if(!state.me){ $('authOverlay').style.display='flex'; return; }
  const name = prompt('Display name', state.me.name) || state.me.name;
  const changeAvatar = confirm('Change avatar image? (OK to open file chooser)');
  if(changeAvatar){
    const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange = (ev)=> {
      const f = ev.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = () => { saveProfile(state.me.email, name, r.result); };
      r.readAsDataURL(f);
    };
    inp.click();
  } else {
    saveProfile(state.me.email, name, state.me.avatar || null);
  }
}
function saveProfile(email, name, avatar){
  const users = load(DB_USERS, []);
  const u = users.find(x=>x.email === email);
  if(u){ u.name = name; u.avatar = avatar; save(DB_USERS, users); state.me = { email, name, avatar }; renderAuthState(); broadcast('user_update', { email }); toast('Profile updated'); }
}

// EXPORT / IMPORT
function exportData(){
  const data = { users: load(DB_USERS, []), rooms: loadRooms(), msgs: load(DB_MSGS, []) };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'chatbox-export.json'; a.click(); URL.revokeObjectURL(url);
}
function importData(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = (ev)=> {
    const f = ev.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try{
        const obj = JSON.parse(r.result);
        if(obj.users) save(DB_USERS, obj.users);
        if(obj.rooms) save(DB_ROOMS, obj.rooms);
        if(obj.msgs) save(DB_MSGS, obj.msgs);
        toast('Imported');
        renderRooms(); if(state.currentRoom) renderMessages();
        broadcast('rooms_updated', {});
      }catch(e){ alert('Invalid file'); }
    };
    r.readAsText(f);
  };
  inp.click();
}

// Theme toggle
function toggleTheme(){
  const a = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  if(a === '#7c3aed') {
    document.documentElement.style.setProperty('--accent', '#06b6d4');
    document.documentElement.style.setProperty('--accent2', '#7c3aed');
  } else {
    document.documentElement.style.setProperty('--accent', '#7c3aed');
    document.documentElement.style.setProperty('--accent2', '#06b6d4');
  }
}

// Utilities
function load(key,fallback){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch(e){ return fallback; } }
function save(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function loadRooms(){ return load(DB_ROOMS, []); }
function saveRooms(r){ save(DB_ROOMS, r); broadcast('rooms_updated', {}); }
function updateOnlineCount(){
  const msgs = load(DB_MSGS, []);
  const recent = msgs.slice(-200);
  const users = {};
  recent.forEach(m => { if(m.from && m.from !== 'system') users[m.from] = true; });
  $('onlineCount').textContent = Object.keys(users).length;
}

// periodic refresh
setInterval(()=> { renderRooms(); renderMessages(); renderRoomPanel(); updateOnlineCount(); }, 1800);

// Expose for debugging
window.chatbox_v12 = { loadUsers: ()=> load(DB_USERS, []), loadRooms, loadMsgs: ()=> load(DB_MSGS, []) };
</script>
</body>
</html>